<!DOCTYPE HTML>
<html lang="es">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">   
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/> 	
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">

	<meta name="theme-color" content="#ECEFF1">
  	<meta name="mobile-web-app-capable" content="yes"> 
  	<meta name="application-name" content="Conteo de Productos"> 

    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/bootstrap.helpers.min.css" />
    <link rel="stylesheet" href="assets/css/snackbar.min.css" />
    <link rel="stylesheet" href="assets/css/merma.css" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
		.notice {
		    padding: 5px 10px;
		    background-color: #fafafa;
		    border-left: 5px solid #7f7f84;
		    margin-bottom: 2px;
		    -webkit-box-shadow: 0 5px 8px -6px rgba(0,0,0,.2);
		       -moz-box-shadow: 0 5px 8px -6px rgba(0,0,0,.2);
		            box-shadow: 0 5px 8px -6px rgba(0,0,0,.2);
		}	
		.inC {
			background: #7f7f84;
			padding: 3px 10px;
			color: #fff;
		}	
		.form-control {
			background: #fff !important;
			padding-left: 7px !important; 
		}
    </style>
  </head>

  <body>
	<header>
		<nav class="navbar navbar-inverse" style="margin-bottom: 10px;">
			<div class="container-fluid">
				<div class="navbar-header">
					<div class="col-xs-12" style="margin: 0;padding: 0;">
						<div class="col-xs-4 col-4" style="margin-top: 20px;">
							<img src="assets/img/menu.png" alt="menu" title="menu" id="slideLeft" style="width: 24px;" />
						</div>
						<div class="col-xs-4 col-4">
							<p class="title">Merma</p>
						</div>
						<div class="col-xs-4 col-4" style="position: absolute;right: -25px;top: 19px;">
							<button type="submit" id="guardarMerma" class="btn btn-sm btn-info pull-right" style="font-weight: 700;background: #263238;border-color: #263238;">Guardar</button>
						</div>
					</div>
				</div>
			</div>
		</nav>
	</header>
	<div class="container">
		<div class="loader"></div>
		<div class="nav" id="menuLeft">
			<p class="text-center" id="usuarioText" style="color: #eee;margin-top: 20px;font-weight: 700;"></p>
			<a href="#" id="logout" class="btn btn-block" style="background: rgb(38, 50, 56);border: 0;color: #eee;">Cerrar sesión</a>
		</div>
		<div class="row">
			<form class="form" role="form" id="formMerma">
				<div class="col-xs-12">
					<div class="col-xs-6">
						<label>Fecha</label>
						<div class="bfh-datepicker" data-format="d/m/y" data-name="FechaLote" id="fechaMerma" data-max="today" style="background: #fff;padding-left:7px;"></div>
						<!--input type="text" class="form-control" name="FechaLote" id="fechaMerma" style="background: #fff;padding-left: 7px;"-->
						<input type="hidden" name="Usuario" id="usuarioMerma" />
						<input type="hidden" name="Imei" id="imeiMerma" />
						<input type="hidden" name="cveInventario" value="1" />
						<input type="hidden" name="cveTipo" value="1" />
					</div>
				</div>
				<div class="col-xs-12" style="margin-top: 10px;">
					<div class="col-xs-6 col-6" style="padding-right: 10px;">
						<label>Planta</label>
						<select name="cvePlanta" id="catPlantas" class="form-control" required>
							<option value="" style="min-height: 39px !important;">Planta</option>
						</select>
					</div>
					<div class="col-xs-6 col-6 pull-right" style="padding-left: 10px;">
						<label>Cedis</label>
						<select name="cveCedis" id="catCedis" class="form-control" required>
							<option value="" style="min-height: 39px !important;">Cedis</option>
						</select>
					</div>
				</div>
				<div class="col-xs-12" style="margin-top: 10px;">
					<div class="col-xs-6 col-6" style="padding-right: 10px;">
						<label># Unidad</label>
						<select name="Unidad" id="catUnidad" class="form-control" required>
							<option value="" style="min-height: 39px !important;">Unidad</option>
						</select>
					</div>
					<div class="col-xs-6 col-6 pull-right" style="padding-left: 10px;">
						<label>Ruta</label>
						<select name="Ruta" id="catRuta" class="form-control" required>
							<option value="" style="min-height: 39px !important;">Ruta</option>
						</select>
					</div>
				</div>
				<div id="hiddenMerma"></div>
			</form>
			<div class="col-xs-12" style="margin-top: 10px;">
				<div class="col-xs-12 text-center slideUp">
					<img src="assets/img/arrowDown.png" alt="up" title="up" id="slideUp" />
				</div>
				<div class="col-xs-12">
					<form id="formScan" class="form-group">
						<label>Código</label>
						<input type="number" id="scanCode" name="scanCode" class="form-control" placeholder="Toca y escanea el código de barras" maxlength="16" disabled />
						<button class="btn btn-default btn-block" id="btnScan" style="background: #7f7f84;display: none;color: #fff;margin: 0 auto;" disabled>Escanear c&oacute;digo</button>
					</form>
				</div>
			</div>
			<div class="col-xs-12" style="margin-top: 5px;">
			    <div id="tableMerma">
			    	<div id="datosMerma">
					</div>
				</div>
			</div>
		</div>
	</div>
  	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="cordova.js" type="text/javascript"></script>
    <script src="assets/js/jquery.min.js" type="text/javascript"></script>
    <script src="assets/js/quo.min.js" type="text/javascript"></script>
    <script src="assets/js/jquery.validate.min.js" type="text/javascript"></script>
    <script src="assets/js/bootstrap.helpers.min.js" type="text/javascript"></script>
    <script src="assets/js/snackbar.min.js" type="text/javascript"></script>
    <script src="assets/js/apiMerma.js" type="text/javascript"></script>
    <script src="assets/js/merma.js" type="text/javascript"></script>
    
    <script type="text/javascript" charset="utf-8">
  		document.addEventListener("deviceready", onDeviceReady, false);

      	function onDeviceReady() {
        	$(function() {

  		        document.addEventListener("backbutton", function (e) {
		            e.preventDefault();
		        }, false );				
        	});

        	$( '#btnScan' ).on('touchcancel click', function(e) {

    			e.preventDefault();

		   		cordova.plugins.barcodeScanner.scan(
		      		function (result) {

		          		$( '.loader' ).fadeOut( '200' ).css( 'display', 'block' );  // Agrega el loading

						var cvePlanta = localStorage.getItem('cvePlanta');
						var scanCode = result.text;
						
						var mermas 		= localStorage.getItem("Mermas");
						var parseMerma 	= JSON.parse(mermas);

						for(var i = 0; i < parseMerma.length; i++) {

							if(parseMerma[i].cvePlanta == cvePlanta && parseMerma[i].Codigo == scanCode) {

								// Crea un nuevo row en la tabla de datosMerma
								$( '#datosMerma' ).append(
									'<div class="notice delete">'+
							        '<strong class="codMerma">' + parseMerma[i].Codigo +
							        '<span class="cajaMerma inC pull-right" contenteditable="true">1</span></strong>'+
							        '<br>'+
							        '<span class="skuMerma" style="font-weight: 500;">' + ('000' + parseMerma[i].SKU).slice(-4)  + '</span> - ' +
							        '<span class="desMerma">' + parseMerma[i].Descripcion + '</span>' +
									'</div>'
								);

								$( '#hiddenMerma' ).append( '<input type="hidden" name="Caja" value="'+ parseMerma[i].Unidad +'">' ); // Se agrega una etiqueta input con el valor asignado
							
								$( '#scanCode' ).val("");

								$( '.loader' ).fadeOut( '200' ).css( 'display', 'none' );  // Quita el loading

								$( '.cajaMerma' ).keydown(function(e) {
									if($(this).text() <= 0) {
										$(this).text("1");
									}
							     	if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {				    
								    	return false;
								    }
								});
							}
						}

		          		$( '.loader' ).fadeOut( '200' ).css( 'display', 'none' );  // Agrega el loading
			      	}, 
		    	  	function (error) {
		          		alert("Escaneo fallido: " + error);
			      	}
		    	);

		    	return;
        	});
      	}
    </script>
    <script type="text/javascript">
      	$.validator.addMethod('regex', function(value, element, param) {
      
        	return this.optional(element) || value.match(typeof param == 'string' ? new RegExp(param) : param);
      	}, 	'Por favor ingresa un formato valido.');
      
      	$(function () {
        	$("#formScan").validate({
          		rules: {
            		scanCode: {
		                required: true,
		                minlength: 12,
		                regex: /^[0-9]{1,14}$/
            		}
          		},
          		messages: {
            		scanCode: {
              			required: "Por favor ingrese un c&oacute;digo valido"
            		}
          		}
        	});
      	});
    </script>
  </body>
</html>